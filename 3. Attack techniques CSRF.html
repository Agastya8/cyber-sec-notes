<h4>What is it</h4><p>CSRF - Cross site request forgery</p><p>CSRF is an attack technique that attempts to circumvent a defensive technique that is marked by CSRF tokens. </p><p>Say you are a website builder and you are creating a new website. You create the profile section which allows you to update your address. Now along comes a bad actor. They analyse the request and are able to forge it. They create their own website and they put a button on there which will call the profile section of your website and which will update the address.&nbsp; </p><p>This means that the attacker can update my address from his website. This may seem pretty innocent but what if instead we replace the functionality with a bank? What if the attacker can send money from the current active account to his account? That would change the matter entirely. </p><p>To prevent this, you as a website builder have several options. One of them is implementing a CSRF token. This token is an extra parameter for your request and is generated on the server and visible to the browser but only via your website. As an attacker, there is no way to gain access to this token without using some illicit tactics (which we will dig deeper into later).&nbsp; If the attacker wants to make the same request, he is missing the CSRF token parameter which will not complete the request and return an error. Hack successfully blocked... or is it?</p><h4>Attack strategy</h4><p>Though the idea of CSRF tokens is very solid, It's easy to mess up the implementation. We as pentesters have several options to test for:</p><ul><li><p>Remove the CSRF token from requests</p></li></ul><ul><li><p>Replace the CSRF token with a random value (for example 1)</p></li></ul><ul><li><p>Replace the CSRF token with a random token of the same restraints</p></li></ul><ul><li><p>Leave CSRF Parameter empty</p></li></ul><ul><li><p>Use a CSRF token that has been used before</p></li></ul><ul><li><p>See if you can request a CSRF by executing the call manually and use that token for the request</p></li></ul><h4>Automation</h4><p>Yes, it is possible to automate this. We will be using the match and replace functions of burp.</p><p>Depending on if the CSRF token is in the HEADER or the BODY section of the request, we will need to pick one.</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-46-49-1783529cce69f91552323e2cbcf32669.png"></figure><p>Fill in the regex to indicate to burp how it can find the CSRF token in your request and replace it with a value of your own. Be careful, this is just an example, it may be different for your target.
</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-46-58-07c45d5c95e7a0270ed50ab57202bd66.png"></figure><p><br></p><p>When this rule is active, click through the application and try to make changes. If you are able to make changes where a CSRF token is normally expected, investigate this further. It may be a vulnerability. To restore normal functionality, simply disable this rule.</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-47-06-972f5205ba631d2658a4ea3fc579f88f.png"></figure><h4>Practical methodology</h4><h4>Portswigger labs</h4><p>We will be using the portswigger labs for this section and we will be creating our methodology in this section. </p><h4>CSRF vulnerability with no defenses</h4><p><a href="https://portswigger.net/web-security/csrf/lab-no-defenses" rel="noopener noreferrer" target="_blank">Lab: CSRF vulnerability with no defenses | Web Security Academy</a></p><p>With your browser proxying traffic through Burp Suite, log in to your account, submit the "Change email" form, and find the resulting request in your Proxy history. If you're using Burp Suite Professional, right-click on the request, and from the context menu select Engagement tools / Generate CSRF PoC.</p><p>https://portswigger.net/web-security/csrf/lab-no-defenses</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-47-28-743efa8b90601c573e1a81242b1c8af9.png"></figure><ul><li><p>Log into the academy, start the lab and open up your burp suite.</p></li></ul><ul><li><p>Copy the URL of the lab, but only the resource name</p><ul><li><p><a href="https://ac1d1fda1ed2a20f80ed507400ce0053.web-security-academy.net/post?postId=6" rel="noopener noreferrer" target="_blank">https://ac1d1fda1ed2a20f80ed507400ce0053.web-security-academy.net/post?postId=6</a></p><ul><li><p>Only the first part of the URL, make sure you also remove the https in front of the URL:</p></li></ul></li></ul><ul><li><p><a href="https://ac1d1fda1ed2a20f80ed507400ce0053.web-security-academy.net/post?postId=6" rel="noopener noreferrer" target="_blank">ac1d1fda1ed2a20f80ed507400ce0053.web-security-academy.net</a></p></li></ul></li></ul><ul><li><p>Navigate to the target tab and open the scope tab.</p></li></ul><ul><li><p>Make sure the "Use advanced scope control" checkmark is checked</p></li></ul><ul><li><p>Click the "Add" button</p></li></ul><ul><li><p>Paste the resource </p></li></ul><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-48-09-d6289b4071c2433d4d97d4dec184915d.png"></figure><ul><li><p>Go to the proxy tab and open a browser</p></li></ul><ul><li><p>Paste the full URL of the lab</p></li></ul><p>When we open up this lab, the first thing we have to do is look at what functionality is available. </p><p>We can see that we have a blogging website where we can:</p><ul><li><p>Login (carlos / montoya)</p></li></ul><ul><li><p>Leave a comment</p></li></ul><ul><li><p>Change our email</p></li></ul><p>Let's try to change our email</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-48-20-e7197bcedff85ef157521d7e94f96483.png"></figure><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-48-24-740eda23368dd63e751084921a1f9bae.png"></figure><p>We can now do the see a request being made to POST /email/change-email with no CSRF token in place. </p><p>Now navigate to <a href="https://security.love/CSRF-PoC-Genorator/" rel="noopener noreferrer" target="_blank">https://security.love/CSRF-PoC-Genorator/</a> , we are going to generate a PoC.</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-48-41-1a8ac1501359b9fc96ed7be0517fb831.png"></figure><p>Copy the email parameter from the request in burp and paste it in the PoC generator, make sure you make some changes so you can verify this CSRF attack later on. To grab the URI, we can right click on our request in burp and click on "Copy URL" from the dropdown menu.</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-49-24-1fec8f3fda922e45d96d742dfb823ffd.png"></figure><p>Now Download the PoC, it should download an HTML file. When you open this file, you should see a button. Make sure you are logged in in another tab and click the button. This should change the users email adress. Verify this if you are doing bug bounties. </p><p>For this lab, we can not complete it in this way and we can not verify the change. To complete the lab, open it again. There will be a button "Go to exploit server", click it and paste the following code into the "body" field:</p><pre class="prettyprint linenums">&lt;form method="POST" action="https://ac1d1fda1ed2a20f80ed507400ce0053.web-security-academy.net/email/change-email"&gt;
&nbsp; &nbsp; &nbsp;&lt;input type="hidden" name="email" value="test231324@gmail.com"&gt;
&lt;/form&gt;
&lt;script&gt;
&nbsp; &nbsp; &nbsp; document.forms[0].submit();
&lt;/script&gt;</pre><p>
</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-50-41-0890782ff3374ebba450f81ba030b8a9.png"></figure><p>Make sure you replace the action URL with the URL of your lab. Next click "store" and then click "exploit".</p><h4>CSRF where token validation depends on request method</h4><p>We repeat the same steps as before until we change our email one time. We should now see another request to POST /email/change-email. Let's right click this request and send it to the repeater.</p><p>If we change our provided CSRF token, we can see that our request is not accepted.</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-49-39-1a83136999b79b35a443d8d07ab6594e.png">However we can also send our POST parameters as GET parameters in a GET request. Some servers also accept GET requests instead of POST request. Burp can easily transform our method by right clicking the request and picking "change request method" from the context menu.</figure><p>This will give us a GET request:</p><pre class="prettyprint linenums">GET /email/change-email?email=test123213%40gmail.com&amp;csrf=123 HTTP/1.1
Host: ac411f2d1e9289fc809251c5007200da.web-security-academy.net
Connection: close
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: https://ac411f2d1e9289fc809251c5007200da.web-security-academy.net
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://ac411f2d1e9289fc809251c5007200da.web-security-academy.net/email
Accept-Encoding: gzip, deflate
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Cookie: session=Vod9PLg2PMNfumbuefWpMLCn78dZItGq</pre><p>Which we can again try to enter in our CSRF PoC generator to prove impact.</p><figure><img src="https://udemy-images.s3.amazonaws.com:443/redactor/raw/article_lecture/2021-03-21_00-50-12-793c5335971b3d75f0031cdb44b1ccfa.png"></figure><p>To solve this lab, we need to make some changes to the payload from the previous lab.</p><pre class="prettyprint linenums">&lt;form method="GET" action="https://ac1d1fda1ed2a20f80ed507400ce0053.web-security-academy.net/email/change-email"&gt;
&nbsp; &nbsp; &nbsp;&lt;input type="hidden" name="email" value="test231324@gmail.com"&gt;
&lt;/form&gt;
&lt;script&gt;
&nbsp; &nbsp; &nbsp; document.forms[0].submit();
&lt;/script&gt;</pre><p>We can again paste this payload in our exploit server and execute the exploit to complete the lab.</p><h4>Validation of CSRF token depends on token being present</h4><p>For this lab, we need to repeat the same steps as before, but this time, we need to remove the CSRF token. Sometimes servers validate a token when it's there and give an error when it's not correct but they might not validate any token if it's not there. </p><p>
</p>